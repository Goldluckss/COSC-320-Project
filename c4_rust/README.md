# C4 Rust Compiler

This project is a Rust implementation of the C4 compiler, originally written by Robert Swierczek in C. The C4 compiler implements a subset of C and is notably compact and self-hosting.

## Features

This Rust implementation maintains the same functionality as the original C4:

- Support for the same subset of C:
  - `char`, `int`, and pointer types
  - `if`, `while`, `return`, and expression statements
  - Function definitions and calls
  - Standard operators: arithmetic, logical, bitwise

- Self-hosting capability (can compile its own source code)
- Virtual machine for executing compiled bytecode

## Enhanced Error Reporting

As a significant improvement over the original C4 compiler, this implementation features enhanced error reporting that provides detailed, context-rich error messages. This makes debugging easier and improves the overall developer experience.

### Key Features of Enhanced Error Reporting:

1. **Location Information**: All errors include precise line and column numbers
2. **Source Context**: Error messages display the relevant line of source code with a pointer to the exact error location
3. **Helpful Suggestions**: Where possible, errors include suggestions for fixing the problem
4. **Categorized Errors**: Errors are clearly categorized as lexer, parser, type, or VM errors
5. **VM Debugging**: Runtime errors include information about the executed instruction and VM cycle

### Example Error Messages:

#### Lexer Error
```
Lexer error: Unexpected character '$'
  --> 5:10
   |
5  | int x = $100;
   |          ^
```

#### Parser Error
```
Parser error: Expected semicolon after expression
  --> 7:15
   |
7  | int x = 5
   |               ^
Suggestion: Add a semicolon: 'int x = 5;'
```

#### Type Error
```
Type error: Cannot subtract character values directly
  --> 12:8
   |
12 | char result = c - 'A';
   |        ^
Suggestion: Convert to int before subtraction: (int)c - 'A'
```

#### VM Error
```
VM error: Division by zero
  When executing: DIV
  At cycle: 42
```

## Building and Running

### Prerequisites

- Rust and Cargo (install from [rustup.rs](https://rustup.rs))

### Building

```bash
cargo build --release
```

### Running

```bash
# Compile and run a C file
./target/release/c4_rust source.c

# Show source code and generated instructions during compilation
./target/release/c4_rust -s source.c

# Show VM execution debugging information
./target/release/c4_rust -d source.c

# Both source and debug output
./target/release/c4_rust -s -d source.c
```

## Project Structure

- `src/`
  - `main.rs` - Entry point and command-line handling
  - `lexer.rs` - Lexical analyzer for tokenizing source code
  - `parser.rs` - Parser for generating bytecode from tokens
  - `symbol.rs` - Symbol table for variable and function tracking
  - `vm.rs` - Virtual machine for executing compiled bytecode
  - `types.rs` - Type definitions used across the compiler
  - `error.rs` - Enhanced error handling system with source context

- `tests/` - Comprehensive test suite including:
  - Unit tests for individual components
  - Integration tests for end-to-end compilation and execution

## Implementation Details

### Lexer

The lexer converts source code into tokens representing language constructs. It handles:

- Keywords: `int`, `char`, `if`, `else`, `while`, `return`, `sizeof`, `enum`
- Identifiers and numeric literals
- String and character literals with escape sequences
- Operators and punctuation
- Comments and preprocessor directives (skipped)

### Parser

The parser analyzes tokens and generates bytecode. It handles:

- Global variable declarations
- Function declarations with parameters
- Statements: `if`, `while`, `return`, blocks, expressions
- Expressions with correct operator precedence
- Type checking and conversion

### Symbol Table

The symbol table manages variable and function declarations:

- Global variables and functions
- Local variables with proper scoping
- Support for different types (int, char, pointer)
- Support for enum constants

### Virtual Machine

The VM executes the generated bytecode:

- Register-based design
- Support for all C4 opcodes
- Stack management for function calls
- Memory operations for variables and arrays
- System calls (printf, etc.) implementation

### Error Handling

The enhanced error reporting system:

- Tracks precise source locations (line and column)
- Captures source context for displaying in error messages
- Provides specific error messages tailored to the error type
- Suggests potential fixes for common errors
- Records VM state at the point of runtime errors

## Comparison with Original C4

This Rust implementation aims to be faithful to the original C4's functionality while taking advantage of Rust's safety features and more modern design:

1. **Memory Safety**: Uses Rust's ownership model to prevent common C bugs
2. **Error Handling**: Significantly improved error messages with source context
3. **Unit Testing**: Comprehensive test suite for all components
4. **Modularity**: Better separation of concerns into distinct modules
5. **Documentation**: Thorough comments and documentation

## C4 Language Subset

The C4 compiler supports a small but powerful subset of C:

### Types
- `int` (64-bit integers in this implementation)
- `char` (8-bit characters)
- Pointers (with `*` syntax)
- Arrays

### Statements
- If-else: `if (condition) { ... } else { ... }`
- While loops: `while (condition) { ... }`
- Return: `return expression;`
- Expression statements: `a = b + c;`
- Blocks: `{ ... }`

### Expressions
- Binary operators: `+`, `-`, `*`, `/`, `%`, `==`, `!=`, `<`, `>`, `<=`, `>=`, `&&`, `||`, `&`, `|`, `^`, `<<`, `>>`
- Unary operators: `-`, `!`, `~`, `*` (dereference), `&` (address-of)
- Function calls: `func(arg1, arg2)`
- Array access: `array[index]`
- Assignment: `var = expression`
- Pre/post increment/decrement: `++var`, `var++`, `--var`, `var--`

### Declarations
- Global variables: `int var;`
- Local variables: `int var;`
- Functions: `int func(int param) { ... }`
- Enums: `enum Name { VALUE1, VALUE2 };`

## Examples

### Hello World
```c
int main() {
    printf("Hello, World!\n");
    return 0;
}
```

### Factorial Function
```c
int factorial(int n) {
    if (n <= 1) {
        return 1;
    }
    return n * factorial(n - 1);
}

int main() {
    printf("5! = %d\n", factorial(5));
    return 0;
}
```

## Limitations

The C4 subset does not support:

- Structs and unions
- Floating-point types
- Switch statements
- For loops (use while instead)
- Standard library (except for a few system calls)
- Preprocessor directives (except for comments)

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Acknowledgments

- Robert Swierczek for the original C4 compiler
- The Rust community for the excellent language and tools